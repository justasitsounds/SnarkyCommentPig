<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <script type="text/javascript" src="/javascripts/raphael-min.js"></script> 
    <script type="text/javascript" src="/javascripts/snarks.js"></script> 
    <script src="http://code.jquery.com/jquery-latest.js"></script>
	<script type="text/javascript" src="http://shared.ninemsn.com.au/share/com/js/common/require.min.js"></script>
    <script type="text/javascript" src="http://shared.ninemsn.com.au/share/com/js/common/amdConfig.js"></script>
    <script type="text/javascript" src="http://shared.ninemsn.com.au/share/short_cache/js/video/ninemsn.portal.common.video.loader-latest.min.js"></script>    

    <script>

    var tweetData = null;
    
	  var dataLoaded = false;

  	function setData(source){
      $.ajax({
        url: '/data?source='+ source,
        success: function(data) {
          tweetData = data;
          dataLoaded = true;
        }
      });
    }
    
    setData('snark');

    function positionCallback() {
    	if(!dataLoaded) return;

    	findTweetAtPosition(window.player.get('POSITION'))
    	setTimeout(positionCallback, 1000);
    }

    function resetCallback() {
    	console.log('resetCallback');
    	$("#pig, #sheep").hide();
    	lastIndex = 0;
    }

    var timeToLive = 5;
    var lastIndex = -1;

	function findTweetAtPosition(pos) {

		var isFriendSource = $("img.img-swap").hasClass('on');       
    
	    var friendIds = ['#friend1', '#friend2'];
	    var snarkIds = ['#sheep', '#pig'];
	    var currentSources = null;

    	for (var i = 0; i < tweetData.length; i++) {

			if(pos > tweetData[i].position && pos < tweetData[i].position + timeToLive)
			{
				if(isFriendSource){
		            currentSources = friendIds;
		            $(snarkIds[0]).fadeOut();
		            $(snarkIds[1]).fadeOut();
		        }else{
		            currentSources = snarkIds;
		            $(friendIds[0]).fadeOut();
		            $(friendIds[1]).fadeOut();
	    		}
		        lastIndex =  i;

		        var id = (lastIndex % 2 == 0) ? currentSources[0] : currentSources[1];
		        var otherid = (lastIndex % 2 == 0) ? currentSources[1] : currentSources[0];
		        var other = $(otherid);
		        var item = $(id);
		        other.fadeOut();
		       
		        item.fadeIn();
		        
		        item.find("> img").attr('src',tweetData[i].profile_image_url);
		        item.find("> h3").text(tweetData[i].screen_name);
		        item.find("> p").text(tweetData[i].tweet);                                 
		        item.find("> a").attr('href','https://twitter.com/' + tweetData[i].screen_name);
		    }
		}
	}

	function initChairsAndAnimals() {

		$("#seats").fadeIn();
		$("#player, #seats, #pig, #sheep").mouseenter(function() { $("#seats").hide(); });
		$("#player").mouseleave(function() { $("#seats").fadeIn(1000); });

	}

  </script>

  </head>
  <body>

  	<div id='bodyCenter'>
  		<img src="/img/header.png">
    	
	    <div class='contentCenter'>
		    <div class='vidCenter' id="player">
			    <script type="text/javascript">

			        (function () {
			            var video = window.ninemsn.portal.common.video;

			            video.ready(function () {
			                window.player = new video.Player({
			                    account: video.enumerations.account.ninemsnCatchup,
			                    adapter: video.enumerations.player.adapter.Brightcove,
			                    outputLocation: 'player',
			                    data: {
			                        method: video.enumerations.data.method.ID,
			                        filter: {
			                            id: '2630968748001'
			                        },
			                    },
			                    height: 585,
			                    width: 1040,
			                    ads: {
				                    freewheel: {
				                        serverUrl: 'http://5c264.v.fwmrm.net',
				                        networkId: 377444,
				                        siteSection: 'noAds'
				                    }
				                }
			                });

							window.player.on('video:playing', positionCallback);
							window.player.on('video:playing', initChairsAndAnimals);
			            });

			        } ());
			    </script>
			</div>

			<img src="img/snarkLabel.png" /> 
			<img src="img/off.png" class="img-swap" />
			<img src="img/friendsLabel.png" />
			<script>
			$("img.img-swap").on('click', function() {            
			    if ($(this).attr("class") == "img-swap") {
			      this.src = this.src.replace("off","on");              
			      setData('sheep');
			    } else {
			      this.src = this.src.replace("on","off");              
			      setData('snark');
			    }
			    $(this).toggleClass("on");
			  });
			</script>


			<div id="seats">
			  	<div id="sheepy">	

			  	</div>
			  	<div id="piggy">	


		  		</div>
		  	</div>
			<blockquote id="sheep" class="example-twitter">
				<h3></h3>
				<p></p>
			</blockquote>			  
			<blockquote id="pig" class="example-twitter">
				<h3></h3>
				<p></p>
			</blockquote>	

	      <blockquote id="friend1" class="example-twitter" cite="http://twitter.com/necolas/status/9880187933">
	        <img src="" />
	        <p></p>
	        <a>link</a>    
	      </blockquote>

	      <blockquote id="friend2" class="example-twitter" cite="http://twitter.com/necolas/status/9880187933">
	        <img />
	        <p></p>
	        <a>link</a>        
	      </blockquote>									

	    </div>

	    <img src="/img/footer.png">
	</div>
		<script type="text/javascript">

			var snark = snarks();
			var pig = snark.pig();

		</script>
  </body>
</html>